name: Publish Package
permissions:
  packages: write # to publish to GitHub Packages
  contents: read
  id-token: write # to publish attestation

on:
  workflow_call:
    inputs:
      version:
        type: string
        required: true
      artifact_name:
        type: string
        required: true
    secrets:
      repo_token:
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6.0.1
        with:
          persist-credentials: false

      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 #v6.0.0
        with:
          node-version: 20
          registry-url: "https://npm.pkg.github.com"
          scope: "@${{ github.repository_owner }}"

      - name: Download artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 #v6.0.0
        with:
          name: ${{inputs.artifact_name}}

      - name: Publish to GitHub Packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.repo_token }}
          INPUTS_VERSION: ${{inputs.version}}
        run: |
          TARBALL=$(ls yldio-percoct-ui-*.tgz)
          if [ -z "$TARBALL" ]; then
            echo "‚ùå No tarball found to publish"
            exit 1
          fi

          echo "üì¶ Publishing $TARBALL to GitHub Packages..."
          npm publish $TARBALL --tag ${INPUTS_VERSION} --access public

          # Verify publication
          PACKAGE_NAME="@yldio/percoct-ui"
          echo "‚ú® Verifying publication of $PACKAGE_NAME@${INPUTS_VERSION} ..."

          # Wait for registry to update
          sleep 5

          # Check if package exists
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.repo_token }}" \
            "https://npm.pkg.github.com/yldio/percoct-ui")

          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ Package successfully published to GitHub Packages"
          else
            echo "‚ùå Failed to verify package publication"
            exit 1
          fi
