name: Publish Package
permissions:
  packages: write # to publish to GitHub Packages
  contents: read

on:
  workflow_call:
    inputs:
      artifact_name:
        type: string
        required: true
    secrets:
      repo_token:
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 #v4.2.2

      - uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a #v4.2.0
        with:
          node-version: 20
          registry-url: "https://npm.pkg.github.com"
          scope: "@${{ github.repository_owner }}"

      - name: Download artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 #v4.1.8
        with:
          name: ${{inputs.artifact_name}}

      - name: Publish to GitHub Packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.repo_token }}
        run: |
          TARBALL=$(ls yldio-percoct-ui-*.tgz)
          if [ -z "$TARBALL" ]; then
            echo "‚ùå No tarball found to publish"
            exit 1
          fi

          echo "üì¶ Publishing $TARBALL to GitHub Packages..."
          npm publish $TARBALL --access public

          # Verify publication
          PACKAGE_NAME="@yldio/percoct-ui"
          VERSION=$(node -p "require('./package.json').version")
          echo "‚ú® Verifying publication of $PACKAGE_NAME@$VERSION..."

          # Wait for registry to update
          sleep 5

          # Check if package exists
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.repo_token }}" \
            "https://npm.pkg.github.com/yldio/percoct-ui")

          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ Package successfully published to GitHub Packages"
          else
            echo "‚ùå Failed to verify package publication"
            exit 1
          fi
